#!/bin/bash

staged_files="$(git diff --name-only --staged)"

# Autoformat Python code.
echo "$staged_files" | grep --quiet ".py" && {
    poetry --help &>/dev/null && [[ -d ".venv" ]] && {
        comma_delimited_filepaths=$(echo "$staged_files" | grep '.py' | tr '\n' ',')
        poetry run invoke qa.autoformat --filepaths "${comma_delimited_filepaths%,}"
    }
}

# Autoformat JS & TS code.
# Match any file types that Prettier can deal with: https://prettier.io/
echo "$staged_files" | grep --quiet -e ".js" -e ".ts" -e ".jsx" -e ".tsx" -e ".scss" -e ".css" && {
    echo "Autoformatting JS/TS code..."
    cd frontend && npx lint-staged && cd ..
}

for file in $staged_files; do
    git add "$file" &>/dev/null
done

echo "Finished pre-commit tasks."
