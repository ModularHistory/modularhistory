version: "3.8"

services:
  celery:
    image: django:latest
    volumes:
      - .:/modularhistory
      - ./wait-for-it.sh:/usr/local/bin/wait-for-it.sh

  celery_beat:
    image: django:latest
    volumes:
      - .:/modularhistory
      - ./wait-for-it.sh:/usr/local/bin/wait-for-it.sh

  django:
    build:
      context: .
      dockerfile: Dockerfile.django
      args:
        ENVIRONMENT: dev
    image: django:latest
    user: root
    volumes:
      - .:/modularhistory
      - ./wait-for-it.sh:/usr/local/bin/wait-for-it.sh

  flower:
    image: django:latest
    volumes:
      - .:/modularhistory
      - ./wait-for-it.sh:/usr/local/bin/wait-for-it.sh

  github_workflow_preprocessor:
    command: sh .github/preprocess.sh
    entrypoint: ''
    image: ghcr.io/mithro/actions-includes/image:main
    user: root
    volumes:
      - .:/github/workspace
      - ./.git:/github/workspace/.git

  react:
    build:
      context: .
      dockerfile: Dockerfile.react
      args:
        ENVIRONMENT: dev
    command: npm run dev
    environment:
      NEXTAUTH_URL: "http://modularhistory.dev.net"
      REACT_EDITOR: "code"
    image: react:latest
    user: root # avoid permissions issues with writing in build dir
    volumes:
      - ./frontend:/modularhistory/frontend
      - ./frontend/node_modules:/modularhistory/frontend/node_modules
      - ./wait-for-it.sh:/usr/local/bin/wait-for-it.sh
