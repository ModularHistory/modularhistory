version: "3.8"

services:
  celery:
    volumes:
      - .:/modularhistory
      - ./wait-for-it.sh:/usr/local/bin/wait-for-it.sh

  celery_beat:
    volumes:
      - .:/modularhistory
      - ./wait-for-it.sh:/usr/local/bin/wait-for-it.sh

  django:
    build:
      context: .
      dockerfile: Dockerfile.django
      args:
        ENVIRONMENT: dev
    volumes:
      - .:/modularhistory
      - ./wait-for-it.sh:/usr/local/bin/wait-for-it.sh

  flower:
    volumes:
      - .:/modularhistory
      - ./wait-for-it.sh:/usr/local/bin/wait-for-it.sh

  react:
    build:
      context: .
      dockerfile: Dockerfile.react
    command: npm run dev
    image: react:latest
    user: root  # avoid permissions issues with writing in build dir
    volumes:
      - ./frontend:/modularhistory/frontend
      # block mounting of subdirectory .next/
      # https://stackoverflow.com/a/37898591
      - /modularhistory/frontend/.next/
      - ./wait-for-it.sh:/usr/local/bin/wait-for-it.sh
